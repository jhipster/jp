name: Auto Translation Pipeline

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Target upstream commit hash'
        required: true
        default: 'HEAD'
      dry_run:
        description: 'Dry run (no actual translation/commit/PR)'
        type: boolean
        default: false
  
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆæ¯æ—¥2æ™‚ã«å®Ÿè¡Œï¼‰
  schedule:
    - cron: '0 2 * * *'

jobs:
  auto-translate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å±¥æ­´ã‚’å–å¾—ã—ã¦upstreamã¨ã®æ¯”è¼ƒã‚’å¯èƒ½ã«ã™ã‚‹
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          cd .github/auto-translation
          pip install -r requirements.txt

      - name: Setup Git configuration
        run: |
          git config --global user.name "jhipster-jp-bot"
          git config --global user.email "jhipster-jp-bot@users.noreply.github.com"

      - name: Run translation pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd .github/auto-translation
          python scripts/run_translation_pipeline.py \
            --hash ${{ github.event.inputs.commit_hash || 'HEAD' }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Upload classification results (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: classification-results
          path: .github/auto-translation/classification.json
          retention-days: 7

      - name: Comment on failure (if workflow_dispatch)
        if: failure() && github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v6
        with:
          script: |
            const message = `ğŸš¨ Auto Translation Pipeline Failed
            
            **Target commit:** \`${{ github.event.inputs.commit_hash || 'HEAD' }}\`
            **Workflow run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Please check the logs for details.`;
            
            // Issueä½œæˆã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ å¯èƒ½
            console.log(message);

  # å®šæœŸå®Ÿè¡Œã§ã®å¤±æ•—é€šçŸ¥
  notify-on-schedule-failure:
    runs-on: ubuntu-latest
    needs: auto-translate
    if: failure() && github.event_name == 'schedule'
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš¨ Scheduled Auto Translation Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `Scheduled auto translation pipeline failed.
            
            **Workflow run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Time:** ${new Date().toISOString()}
            
            Please investigate the failure and run manually if needed.
            
            \`\`\`
            gh workflow run auto-translation-pipeline.yml -f commit_hash=HEAD -f dry_run=false
            \`\`\``;
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['auto-translation', 'bug']
              });
            } catch (error) {
              console.log('Failed to create issue:', error);
            }