# JHipsteræ—¥æœ¬èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ  Makefile

.PHONY: install test run clean help

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "JHipsteræ—¥æœ¬èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ "
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  install     - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  test        - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  run         - è‡ªå‹•ç¿»è¨³ã‚’å®Ÿè¡Œï¼ˆå…¨ä½“ï¼‰"
	@echo "  run-dry     - è‡ªå‹•ç¿»è¨³ã‚’ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
	@echo "  run-new     - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ç¿»è¨³"
	@echo "  clean       - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  lint        - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°:"
	@echo "  GEMINI_API_KEY  - Gemini APIã‚­ãƒ¼ï¼ˆå¿…é ˆï¼‰"
	@echo "  GH_TOKEN        - GitHub Tokenï¼ˆPRä½œæˆç”¨ï¼‰"
	@echo "  COMMIT_HASH     - ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’æŒ‡å®š"

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	@echo "ğŸ“¦ Installing dependencies..."
	poetry install

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test:
	@echo "ğŸ§ª Running tests..."
	poetry run pytest tests/ -v

# ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
lint:
	@echo "ğŸ” Running code quality checks..."
	poetry run python -m py_compile scripts/*.py
	@echo "âœ… Code quality check completed"

# è‡ªå‹•ç¿»è¨³å®Ÿè¡Œï¼ˆå…¨ä½“ï¼‰
run: check-env
	@echo "ğŸš€ Running auto-translation (full mode)..."
	@if [ -n "$(COMMIT_HASH)" ]; then \
		poetry run python scripts/fetch_upstream.py --hash "$(COMMIT_HASH)"; \
	else \
		poetry run python scripts/fetch_upstream.py; \
	fi
	@poetry run python scripts/classify_changes.py --output-format json > classification.json
	@poetry run python scripts/classify_changes.py --output-format summary
	@poetry run python scripts/translate_chunk.py --classification classification.json --mode all
	@poetry run python scripts/postprocess.py --classification classification.json
	@poetry run python scripts/commit_and_pr.py --classification classification.json

# ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
run-dry: check-env
	@echo "ğŸ§ª Running auto-translation (dry-run mode)..."
	@export DRY_RUN=true && $(MAKE) run

# æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ç¿»è¨³
run-new: check-env
	@echo "ğŸ†• Running auto-translation (new files only)..."
	@if [ -n "$(COMMIT_HASH)" ]; then \
		poetry run python scripts/fetch_upstream.py --hash "$(COMMIT_HASH)"; \
	else \
		poetry run python scripts/fetch_upstream.py; \
	fi
	@poetry run python scripts/classify_changes.py --output-format json > classification.json
	@poetry run python scripts/translate_chunk.py --classification classification.json --mode new-only
	@poetry run python scripts/postprocess.py --classification classification.json
	@poetry run python scripts/commit_and_pr.py --classification classification.json

# é¸æŠçš„ç¿»è¨³ï¼ˆè¡çªãƒ•ã‚¡ã‚¤ãƒ«é™¤å¤–ï¼‰
run-selective: check-env
	@echo "ğŸ“ Running auto-translation (selective mode)..."
	@if [ -n "$(COMMIT_HASH)" ]; then \
		poetry run python scripts/fetch_upstream.py --hash "$(COMMIT_HASH)"; \
	else \
		poetry run python scripts/fetch_upstream.py; \
	fi
	@poetry run python scripts/classify_changes.py --output-format json > classification.json
	@poetry run python scripts/translate_chunk.py --classification classification.json --mode selective
	@poetry run python scripts/postprocess.py --classification classification.json
	@poetry run python scripts/commit_and_pr.py --classification classification.json

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ğŸ§¹ Cleaning up..."
	@rm -f classification.json
	@rm -f *.log
	@rm -rf .pytest_cache/
	@rm -rf __pycache__/
	@find . -name "*.pyc" -delete
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Cleanup completed"

# ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
check-env:
	@if [ -z "$(GEMINI_API_KEY)" ] || [ "$(GEMINI_API_KEY)" = "fake_api_key_for_development" ]; then \
		echo "âŒ GEMINI_API_KEY environment variable is required"; \
		echo "   Please set your Gemini API key:"; \
		echo "   export GEMINI_API_KEY=your_actual_api_key"; \
		exit 1; \
	fi

# é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
dev-setup: install
	@echo "ğŸ”§ Setting up development environment..."
	@cp .env.sample .env || true
	@echo "âœ… Development environment setup completed"
	@echo ""
	@echo "Next steps:"
	@echo "1. Edit .env file with your actual API keys"
	@echo "2. Run 'make test' to verify setup"
	@echo "3. Run 'make run-dry' to test translation workflow"

# å€‹åˆ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
fetch:
	@poetry run python scripts/fetch_upstream.py $(if $(COMMIT_HASH),--hash $(COMMIT_HASH))

classify:
	@poetry run python scripts/classify_changes.py

translate:
	@poetry run python scripts/translate_chunk.py --classification classification.json --mode selective

postprocess:
	@poetry run python scripts/postprocess.py --classification classification.json

commit:
	@poetry run python scripts/commit_and_pr.py --classification classification.json