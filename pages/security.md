---
layout: default
title: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
permalink: /security/
redirect_from:
  - /security.html
sitemap:
    priority: 0.7
    lastmod: 2023-12-01T18:00:00-00:00
---

# <i class="fa fa-lock"></i> ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«

<<<<<<< HEAD
JHipsterã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã®ã‚ˆã†ã«ã€å˜ä¸€ã®Webãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§Spring Securityã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Ajaxã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ/ã‚¨ãƒ©ãƒ¼ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ“ãƒ¥ãƒ¼ã‚’æ­£ã—ãä½¿ç”¨ã™ã‚‹ãŸã‚ã«Spring Securityã‚’è¨­å®šã—ã€ã™ã¹ã¦ã®JavaScriptã¨HTMLã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€JHipsterã«ã¯2ã¤ã®ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãŒã„ã¾ã™ã€‚
=======
To use Spring Security with a Single Web Page Application, like the ones generated by JHipster, you need XHR login/logout/error views. We have configured Spring Security in order to use those views correctly, and we generate all the JavaScript and HTML code for you.

By default, JHipster comes with two different users:
>>>>>>> upstream/main

* "user"ï¼šã“ã‚Œã¯"ROLE_USER"æ¨©é™ã‚’æŒã¤é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯"user"ã§ã™ã€‚
* "admin"ï¼š"ROLE_USER"ãŠã‚ˆã³"ROLE_ADMIN"æ¨©é™ã‚’æŒã¤ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯"admin"ã§ã™ã€‚

<<<<<<< HEAD
"ROLE_USER"ã¨"ROLE_ADMIN"ã®2ã¤ã®æ¨©é™ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã—ã¦åŒã˜ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€"user"ã¯"admin"ã¨åŒã˜CRUDæ“ä½œã™ã‚‹æ¨©é™ã‚’ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å‹•ä½œã¯ã€"user"ãŒä»»æ„ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‰Šé™¤ã§ãã‚‹ãªã©ã®ç†ç”±ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ¬ç•ªã«ç§»è¡Œã™ã‚‹ã¨ãã«å•é¡Œã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’æ”¹å–„ã™ã‚‹æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ã“ã®[ãƒ–ãƒ­ã‚°æŠ•ç¨¿](https://blog.ippon.tech/improving-the-access-control-of-a-jhipster-application/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
=======
The two authorizations "ROLE_USER" and "ROLE_ADMIN" provide the same access to the entities, which means that a "user" is authorized to perform the same CRUD operations as an "admin". This behavior can be an issue when the application goes to production because a "user" can, for example, delete any entities. More details on improving access-control can be found in this [blog post](https://blog.ippon.tech/improving-the-access-control-of-a-jhipster-application/).
>>>>>>> upstream/main

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€é‹ç”¨ç’°å¢ƒã§ã¯ã“ã‚Œã‚‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

JHipsterã¯ã€3ã¤ã®ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã¾ã™ã€‚

1. [JSON Web Tokens (JWT)](#jwt)
<<<<<<< HEAD
2. [ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼](#session)
3. [OAuth 2.0ã¨OpenID Connect](#oauth2)
=======
2. [Session-based authentication](#session)
3. [OAuth 2.0 and OpenID Connect](#oauth2)
   - [Keycloak](#keycloak)
   - [Auth0](#auth0)
   - [Okta](#okta)
>>>>>>> upstream/main

<h2 id="jwt">JSON Web Tokens (JWT)</h2>

[JSON Web Token (JWT)](https://jwt.io/)èªè¨¼ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãªã®ã§ã€è¤‡æ•°ã®ç•°ãªã‚‹ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‹¡å¼µã—ãŸã„å ´åˆã«ã¯è‰¯ã„é¸æŠè‚¢ã§ã™ã€‚

[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](/microservices-architecture/)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã®èªè¨¼ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Spring Securityã«ã¯å­˜åœ¨ã›ãšã€[Java JWTãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ](https://github.com/jwtk/jjwt)ã‚’çµ±åˆã—JHipsterã«ç‰¹åŒ–ã•ã›ãŸã‚‚ã®ã§ã™ã€‚

ã“ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³åã¨æ¨©é™ã‚’ä¿æŒã™ã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç½²åã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚

JHipsterã¯ã€ç„¡åŠ¹ãªJWTã‚’ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦è‡ªå‹•çš„ã«è¿½è·¡ã—ã¾ã™ã€‚[ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](/monitoring/#security-metrics)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### JWTã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«

- JHipsterã¯ã€`jhipster.security.authentication.jwt.secret`ã¨`jhipster.security.authentication.jwt.base64-secret`ã¨ã„ã†2ã¤ã®Spring Bootãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦è¨­å®šã§ãã‚‹ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
2ç•ªç›®ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€Base 64ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ä½¿ç”¨ã—ã€ã‚ˆã‚Šå®‰å…¨ã§ã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹ãŸã‚ã€æ¨å¥¨ã—ã¾ã™ã€‚ä¸¡æ–¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¬ã‚¬ã‚·ãƒ¼ãªç†ç”±ã«ã‚ˆã‚Šã€`secret`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä½ã„æ–¹ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
Base64ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•æ™‚ã«è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- ã“ã‚Œã‚‰ã®ã‚­ãƒ¼ã®æœ€å°é•·ã¯512ãƒ“ãƒƒãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ååˆ†ãªé•·ã•ãŒãªã„å ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ãã®å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãã®å•é¡Œã‚’èª¬æ˜ã™ã‚‹æ˜ç¢ºãªè­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- ç§˜å¯†éµã¯`application-*.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®éµã¯ç§˜å¯†ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã«å®‰å…¨ãªæ–¹æ³•ã§ä¿ç®¡ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚
é€šå¸¸ã€Spring Bootãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šã‚’ä½¿ç”¨ã—ã¦è¨­å®šã§ãã¾ã™ã€‚[JHipster Registry](/jhipster-registry/)ã®ã‚ˆã†ãªSpring Cloud Configã‚µãƒ¼ãƒã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€
ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ã‚ˆã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œå¯èƒ½ãªWARãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«SCPã§ç½®ã‹ã‚ŒãŸç‰¹æœ‰ã®`application-prod.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®"user"ãŠã‚ˆã³"admin"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯**å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã“ã‚Œã‚’è¡Œã†æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€"user/user"ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰"admin/admin"ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ãã‚Œãã‚Œã«å¯¾ã—ã¦"Account > Password"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã™ã€‚

<h2 id="session">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼</h2>

ã“ã‚Œã¯ã€Œå¤å…¸çš„ãªã€Spring Securityèªè¨¼ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã™ãŒã€å¤§å¹…ã«æ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚HTTPã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã™ã€‚è¤‡æ•°ã®ã‚µãƒ¼ãƒã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‹¡å¼µã™ã‚‹å ´åˆã¯ã€å„ãƒ¦ãƒ¼ã‚¶ãŒåŒã˜ã‚µãƒ¼ãƒã«ã¨ã©ã¾ã‚‹ã‚ˆã†ã«ã€ã‚¹ãƒ†ã‚£ãƒƒã‚­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‚™ãˆãŸãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€[Spring Session](https://spring.io/projects/spring-session)ã‚’è¿½åŠ ã—ã¦ã€ãƒ¡ãƒ¢ãƒªã§ã¯ãªããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«

- Remember-meèªè¨¼ã®å ´åˆã€Remember-meã‚­ãƒ¼ã¯`application-dev.yml`ãŠã‚ˆã³`application-prod.yml`ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ã€`jhipster.security.remember-me.key`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚ã“ã®ã‚­ãƒ¼ã¯ç§˜å¯†ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã«å®‰å…¨ãªæ–¹æ³•ã§ä¿å­˜ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚é€šå¸¸ã€Spring Bootãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šã‚’ä½¿ç”¨ã—ã¦è¨­å®šã§ãã¾ã™ã€‚[JHipster Registry](/jhipster-registry/)ã®ã‚ˆã†ãªSpring Cloud Configã‚µãƒ¼ãƒã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ã‚ˆã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œå¯èƒ½ãªWARãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«SCPã§ç½®ã‹ã‚ŒãŸç‰¹æœ‰ã®`application-prod.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®"user"ãŠã‚ˆã³"admin"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯**å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã“ã‚Œã‚’è¡Œã†æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€"user/user"ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰"admin/admin"ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ãã‚Œãã‚Œã«å¯¾ã—ã¦"Account > Password"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã™ã€‚

### remember-meãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®æ”¹å–„

ç§ãŸã¡ã¯ã€Spring Securityã®remember-meãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å¤‰æ›´ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSQLã¾ãŸã¯NoSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ç”Ÿæˆæ™‚ã®é¸æŠã«å¿œã˜ã¦ï¼ï¼‰ã«æ ¼ç´ã•ã‚Œã‚‹ç‹¬è‡ªã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã¾ãŸã€æ¨™æº–ã®å®Ÿè£…ã‚ˆã‚Šã‚‚å¤šãã®æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ã‚ˆã†ã«ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®å‡ºæ‰€ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€æ—¥ä»˜ãªã©ï¼‰ã‚’ã‚ˆã‚Šã‚ˆãç†è§£ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€å®Œå…¨ãªç®¡ç†ç”»é¢ã‚’ç”Ÿæˆã—ã€åˆ¥ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã®ã‚’å¿˜ã‚ŒãŸå ´åˆãªã©ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹ã«ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

### Cookieã®ç›—é›£å¯¾ç­–

ç§ãŸã¡ã¯ã€å®Œæˆåº¦ã®é«˜ã„Coockieç›—é›£é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã‚ãªãŸã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ã‚’Cookieã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã³ã«ãã‚Œã‚‰ã®å€¤ã‚’ä¿®æ­£ã—ã€ãã‚Œã‚‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã™ã‚‹ã“ã¨ã§ã€èª°ã‹ãŒã‚ãªãŸã®Coockieã‚’ç›—ã‚“ã å ´åˆã§ã‚‚ã€ä½¿ç”¨ã§ãã‚‹ã®ã¯æœ€å¤§ã§1å›ã ã‘ã¾ã™ã€‚

<h2 id="oauth2">OAuth 2.0ã¨OpenID Connect</h2>

OAuthã¯ã€HTTPã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã™ã€‚Spring Securityã¯ã€å„ªã‚ŒãŸOAuth 2.0ã¨OIDCã®ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯JHipsterã«ã‚ˆã£ã¦æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚OAuthã¨OpenID Connect(OIDC)ãŒä½•ã§ã‚ã‚‹ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€[OAuthã¨ã¯ä½•ã‹?](https://developer.okta.com/blog/2017/06/21/what-the-heck-is-oauth)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Keycloak

[Keycloak](https://www.keycloak.org)ã¯ã€JHipsterã§è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®OpenID Connectã‚µãƒ¼ãƒã§ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã«ã¯ã€[Keycloak](https://www.keycloak.org)ã‚’èµ·å‹•ã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚JHipsterãƒãƒ¼ãƒ ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ã‚’æŒã¤Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦Keycloakã‚’èµ·å‹•ã—ã¾ã™ã€‚

```shell
docker-compose -f src/main/docker/keycloak.yml up
```
ã‚ã‚‹ã„ã¯ã€æ¬¡ã®ã‚ˆã†ãª`npm`ã®ä½¿ç”¨ã‚‚ã§ãã¾ã™ã€‚

```shell
npm run docker:keycloak:up
```

Docker Composeã§Keycloakã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€[Docker Composeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](/docker-compose/)ã‚’å¿…ãšèª­ã¿ã€Keycloakç”¨ã«`/etc/hosts`ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„ã€‚

> <i class="fa fa-info-circle"></i>**Apple Silicon(M1)ä¸Šã®JHipster 7.8.1ãŠã‚ˆã³Keycloak 16.1.0ã«é–¢ã™ã‚‹æ³¨æ„**
> 
> v18ã‚ˆã‚Šå‰ã®Keycloakã¯ã€äº’æ›ãƒ¢ãƒ¼ãƒ‰ã®Apple Siliconã§èª¤å‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€è§£æ±ºç­–ã¯æ˜ã‚‰ã‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®å•é¡Œã¯Keycloakã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚
> 
> ```
> git clone git@github.com:keycloak/keycloak-containers.git
> cd keycloak-containers/server
> git checkout 16.1.0
> docker build -t jboss/keycloak:16.1.0 .
> ```

ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ã€`src/main/resources/config/application.yml`ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãŒæ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸Šè¨˜ã®`/etc/hosts`ã«é–¢ã™ã‚‹æ³¨æ„ã‚’å‚ç…§ã—ã€`issuer-uri`ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```yaml
spring:
  ...
  security:
    oauth2:
      client:
        provider:
          oidc:
            issuer-uri: http://localhost:9080/auth/realms/jhipster
            # localhostã¯ã€ãƒ›ã‚¹ãƒˆã§ã¯ãªãã€ã‚²ã‚¹ãƒˆ(ã‚³ãƒ³ãƒ†ãƒŠ)ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¾ã™ã€‚
            # Keycloakã‚’ãƒ‡ãƒ¼ãƒ¢ãƒ³ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã«ã¯ã€npm run docker:keycloak:upã¨ãªã‚Šã€/etc/hostsã®ç·¨é›†ã¨ã€
            # issuer-uriã‚’æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            # issuer-uri: http://keycloak:9080/auth/realms/jhipster
        registration:
          oidc:
            client-id: web_app
            client-secret: web_app
            scope: openid,profile,email
```

Keycloakã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§çµ„ã¿è¾¼ã¿H2ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãŒå¤±ã‚ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã«ã¯ã€[Keycloak Dockerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://hub.docker.com/r/jboss/keycloak/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚H2ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¿æŒã™ã‚‹1ã¤ã®è§£æ±ºç­–ã¯ã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

- æ°¸ç¶šåŒ–ã™ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¾ã™ï¼š`./keycloak-db:/opt/jboss/keycloak/standalone/data`
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•ã‚’`OVERWRITE_EXISTING`ã‹ã‚‰`IGNORE_EXISTING`ã«å¤‰æ›´ã—ã¾ã™ï¼ˆã‚³ãƒãƒ³ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ï¼‰

æœ¬ç•ªç’°å¢ƒã§ã¯ã€HTTPSã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒKeycloakã«ã‚ˆã£ã¦è¦æ±‚ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€HTTPSã‚’ç®¡ç†ã™ã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ»ãƒ—ãƒ­ã‚­ã‚·ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒãƒ©ãƒ³ã‚µã‚’ä½¿ç”¨ã™ã‚‹ãªã©ã€ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã®è©³ç´°ã‚’çŸ¥ã‚‹ã«ã¯ã€[Keycloak HTTPSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.keycloak.org/docs/latest/server_installation/index.html#setting-up-https-ssl)ã‚’èª­ã‚€ã“ã¨ã‚’ãŠè–¦ã‚ã—ã¾ã™ã€‚

### Auth0

If you'd like to use [Auth0](https://auth0.com/) instead of Keycloak, follow the configuration steps below:

#### Create an OIDC App using Auth0 Admin Dashboard

- Create a free developer account at <https://auth0.com/signup>. After successful sign-up, your account shall be associated with a unique domain like `dev-xxx.us.auth0.com`
- Create a new application of type `Regular Web Applications`. Switch to the `Settings` tab, and configure your application settings like:
    - Allowed Callback URLs: `http://localhost:8080/login/oauth2/code/oidc`
    - Allowed Logout URLs: `http://localhost:8080/`
    - NOTE: If you're using Consul, add URLs for port 8500 too.
    - NOTE: If you're using the JHipster Registry, add URLs for port 8761 too.
- Navigate to **User Management** > **Roles** and create new roles named `ROLE_ADMIN`, and `ROLE_USER`.
- Navigate to **User Management** > **Users** and create a new user account. Click on the **Role** tab to assign roles to the newly created user account.
- Navigate to **Actions** > **Flows** and select **Login**. Create a new action named `Add Roles` and use the default trigger and runtime. Change the `onExecutePostLogin` handler to be as follows:

  ```js
  exports.onExecutePostLogin = async (event, api) => {
    const namespace = 'https://www.jhipster.tech';
    if (event.authorization) {
      api.idToken.setCustomClaim('preferred_username', event.user.email);
      api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
      api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    }
  }
  ```
- Select **Deploy** and drag the `Add Roles` action to your Login flow.

_If you'd like to have all these steps automated for you, add a ğŸ‘ to [issue #351](https://github.com/auth0/auth0-cli/issues/351) in the Auth0 CLI project._

#### Configure JHipster Application to use Auth0 as OIDC Provider

In your `JHipster` application, modify `src/main/resources/config/application.yml` to use your Auth0 settings:

```yaml
spring:
  ...
  security:
    oauth2:
      client:
        provider:
          oidc:
            # make sure to include the ending slash!
            issuer-uri: https://{your-auth0-domain}/
        registration:
          oidc:
            client-id: {clientId}
            client-secret: {clientSecret}
            scope: openid,profile,email,offline_access
jhipster:
  security:
    oauth2:
      audience: https://{your-auth0-domain}/api/v2/
```

If you have a doubt on the `issuer-uri` value, then, you can get the value from **Applications** > **{Your Application}** > **Settings** > **Advanced Settings** > **Endpoints** > **OpenID Configuration**. Remove `.well-known/openid-configuration` suffix since that will be added by the Spring Security.

You can use the default `Auth0 Management API` audience value from the **Applications** > **API** > **API Audience** field. You can also define your own custom API and use the identifier as the API audience.

- Before running `Cypress` tests, specify `Auth0` user details by overriding the `CYPRESS_E2E_USERNAME` and `CYPRESS_E2E_PASSWORD` environment variables. Refer to [Cypress documentation](https://docs.cypress.io/guides/guides/environment-variables#Setting) for more details.

```shell
export CYPRESS_E2E_USERNAME=<your-username>
export CYPRESS_E2E_PASSWORD=<your-password>
```

_Note_: Auth0 requires a user to provide authorization consent on the first login. Consent flow is currently not handled in the Cypress test suite. To mitigate the issue, you can use a user account that has already granted consent to authorize application access via interactive login.

#### Use Environment Variables

You can also use environment variables to override the defaults. For example:

```bash
export SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI="https://{your-auth0-domain}/"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID="{client-id}"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET="{client-secret}"
export JHIPSTER_SECURITY_OAUTH2_AUDIENCE="https://{your-auth0-domain}/api/v2/"
```

You can put this in an `~/.auth0.env` file and run `source ~/.auth0.env` to override the default Keycloak settings with Auth0 and start your app with Maven or Gradle. You should be able to sign in with the credentials you registered with.

_Note_: If you're on `Windows`, you should install [WSL](https://docs.microsoft.com/en-us/windows/wsl/install-win10) so the `source` command will work.

<a name="create-native-app-auth0"></a>
#### Create a Native App for Mobile on Auth0

If you're developing a mobile app with JHipster's [Ionic](https://github.com/jhipster/generator-jhipster-ionic) or [React Native](https://github.com/jhipster/generator-jhipster-react-native) blueprints, you will need to create a native app on Auth0 if you're using OIDC.

1. Create a **Native** app and add the following Allowed Callback URLs:

    - Ionic: `http://localhost:8100/callback,dev.localhost.ionic:/callback`
    - React Native: `http://localhost:19006/,https://auth.expo.io/@<username>/<appname>`

2. Set the Allowed Logout URLs to:

    - Ionic: `http://localhost:8100/logout,dev.localhost.ionic:/logout`
    - React: `http://localhost:19006/,https://auth.expo.io/@<username>/<appname>`

3. Set the Allowed Origins (CORS):

    - Ionic: `http://localhost:8100,capacitor://localhost,http://localhost`
    - React Native: `http://localhost:19006`

#### Update Your Ionic App

Update `ionic/src/environments/environment.ts` to use the generated client ID. The value for `server_host` will be looked up from your JHipster app (at `/api/auth-info`), but you can define it as a fallback value. You'll also need to specify the audience. For example:

```ts
const oidcConfig: IAuthConfig = {
  client_id: '<native-client-id>',
  server_host: 'https://<your-auth0-domain>/',
  ...
};

export const environment = {
  ...
  audience: 'https://<your-auth0-domain>/api/v2/',
  ...
};
```

Restart your Ionic app and log in with Auth0!

#### Update Your React Native App

Copy the client ID to `app/config/app-config.js`.

Update the `audience` in `app/modules/login/login.utils.ts`:

```ts
audience: 'https://<your-auth0-domain>/api/v2/',
```

Restart your React Native app and log in with Auth0!

### Okta

Keycloakã®ä»£ã‚ã‚Šã«Oktaã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€[Okta CLI](https://cli.okta.com/)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã‹ãªã‚Šæ—©ã„ã§ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```shell
okta register
```

æ¬¡ã«ã€JHipsterã‚¢ãƒ—ãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§`okta apps create jhipster`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Oktaã‚¢ãƒ—ãƒªãŒè¨­å®šã•ã‚Œã€`ROLE_ADMIN`ã‚°ãƒ«ãƒ¼ãƒ—ã¨`ROLE_USER`ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½œæˆã•ã‚Œã€Oktaè¨­å®šã‚’å«ã‚€`.okta.env`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã€IDãƒˆãƒ¼ã‚¯ãƒ³ã«`groups`ã‚¯ãƒ¬ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚

`source .okta.env`ã‚’å®Ÿè¡Œã—ã€Mavenã¾ãŸã¯Gradleã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚ç™»éŒ²ã—ãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã¯ãšã§ã™ã€‚

Windowsã®å ´åˆã¯ã€`source`ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€[WSL](https://docs.microsoft.com/en-us/windows/wsl/install-win10)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Okta Admin Consoleã‹ã‚‰æ‰‹å‹•ã§è¨­å®šã™ã‚‹å ´åˆã¯ã€æ¬¡ã®æ‰‹é †ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### Oktaç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸOIDCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

ã¾ãšã€<https://developer.okta.com/signup>ã§ç„¡æ–™ã®é–‹ç™ºè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€`https://dev-123456.okta.com`ã®ã‚ˆã†ãªåå‰ã®ç‹¬è‡ªã®Oktaãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚

Oktaã®è¨­å®šã‚’ä½¿ã†ãŸã‚ã«`src/main/resources/config/application.yml`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ãƒ’ãƒ³ãƒˆï¼š`{yourOktaDomain}`ã‚’ã‚ãªãŸã®çµ„ç¹”ã®åå‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼ˆä¾‹ï¼š`dev-123456.okta.com`ï¼‰ã€‚

```yaml
security:
  oauth2:
    client:
      provider:
        oidc:
          issuer-uri: https://{yourOktaDomain}/oauth2/default
      registration:
        oidc:
          client-id: {client-id}
          client-secret: {client-secret}
          scope: openid,profile,email
```

Oktaã§OIDCã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã€`{client-id}`ã¨`{client-secret}`ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€Okta Developerã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€**Applications** > **Applications** > **Add Application** > **Create New App**ã«ç§»å‹•ã—ã¾ã™ã€‚**Web**, **OpenID Connect**ã‚’é¸æŠã—ã€**Create**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã«è¦šãˆã‚„ã™ã„åå‰ã‚’ä»˜ã‘ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã¨ã—ã¦`http://localhost:8080/login/oauth2/code/oidc`ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã¨ã—ã¦`http://localhost:8080`ã‚’è¿½åŠ ã—ã€**Save**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’`application.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

`ROLE_ADMIN`ãŠã‚ˆã³`ROLE_USER`ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ï¼ˆ**Directory** > **Groups** > **Add Group**ï¼‰ã€ãã‚Œã‚‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ï¼ˆ**Directory** > **People** > **Add Person**ï¼‰ã€‚**Security** > **API** > **Authorization Servers**ã«ç§»å‹•ã—ã€`default`ã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚**Claims**ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€**Add Claim**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚`groups`ã¨ã„ã†åå‰ã‚’ä»˜ã‘ã¦ã€IDãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã‚ã¾ã™ã€‚å€¤ã®ã‚¿ã‚¤ãƒ—ã‚’`Groups`ã«è¨­å®šã—ã€ãƒ•ã‚£ãƒ«ã‚¿ã‚’`.*`ã®æ­£è¦è¡¨ç¾ã«è¨­å®šã—ã¾ã™ã€‚**Create**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

<img src="/images/security-add-claim.png" alt="Add Claim" width="600" style="margin: 10px"> 

ã“ã‚Œã‚‰ã‚’å¤‰æ›´ã—ãŸå¾Œã€å•é¡Œãªãä½¿ç”¨ã§ãã‚‹ã¯ãšã§ã™ï¼ã€€ã‚‚ã—å•é¡ŒãŒã‚ã‚Œã°[Stack Overflow](https://stackoverflow.com/questions/tagged/jhipster)ã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚è³ªå•ã«ã¯å¿…ãš"jhipster"ã¨"okta"ã®ã‚¿ã‚°ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚

e2eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚ã«Oktaã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚

```shell
export CYPRESS_E2E_USERNAME=<your-username>
export CYPRESS_E2E_PASSWORD=<your-password>
```

Protractorã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`CYPRESS_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

#### ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨

ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸Šæ›¸ã‚‚ã§ãã¾ã™ã€‚æ¬¡ã«ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

```bash
export SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI="https://{yourOktaDomain}/oauth2/default"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID="{client-id}"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET="{client-secret}"
```

ã“ã‚Œã‚’`~/.okta.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«å…¥ã‚Œã¦`source ~/.okta.env`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Keycloakã‚’Oktaã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ãã¾ã™ã€‚

æ¬¡ã«ã€Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã«ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã§ãã¾ã™ã€‚

```bash
heroku config:set \
  SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI="$SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI" \
  SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID="$SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID" \
  SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET="$SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET"
```

<a name="create-native-app-okta"></a>
#### Oktaã§ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹

JHipsterã®[Ionic](https://github.com/jhipster/generator-jhipster-ionic)ã¾ãŸã¯[React Native](https://github.com/jhipster/generator-jhipster-react-native)ã®Blueprintã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ã„ã‚‹å ´åˆã€OIDCã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãªã‚‰ã€Oktaã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

[Okta CLI](https://cli.okta.com)ã‚’ä½¿ç”¨ã—ã¦`okta apps create`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ—ãƒªåã‚’é¸æŠã™ã‚‹ã‹ã€å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¾ã™ã€‚**Native**ã‚’é¸æŠã—ã¦**Enter**ã‚’æŠ¼ã—ã¾ã™ã€‚

- **Ionic**ï¼šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’`[http://localhost:8100/callback,dev.localhost.ionic:/callback]`ã«å¤‰æ›´ã—ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’`[http://localhost:8100/logout,dev.localhost.ionic:/logout]`ã«å¤‰æ›´ã—ã¾ã™ã€‚
- **React Native**ï¼šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã«ã¯`[http://localhost:19006/,https://auth.expo.io/@<username>/<appname>]`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**æ³¨æ„:** `dev.localhost.ionic`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒ ã§ã™ãŒã€`com.okta.dev-133337`ï¼ˆã“ã“ã§`dev-133337.okta.com`ã¯ã‚ãªãŸã®Okta Orgã®URLã§ã™ï¼‰ã®ã‚ˆã†ãªã€ã‚ˆã‚Šãƒˆãƒ©ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ«ãªã‚‚ã®ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€Ionicã‚¢ãƒ—ãƒªã®`src/environments/environment.ts`ã®`scheme`ã‚’å¿…ãšæ›´æ–°ã—ã¦ãã ã•ã„ã€‚

Okta CLIã¯ã€Okta Orgã«OIDC Appã‚’ä½œæˆã—ã¾ã™ã€‚æŒ‡å®šã—ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’è¿½åŠ ã—ã€Everyoneã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

```shell
Okta application configuration:
Issuer:    https://dev-133337.okta.com/oauth2/default
Client ID: 0oab8eb55Kb9jdMIr5d6
```

**æ³¨æ„**ï¼šOktaç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’ä½œæˆã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®ä½œæˆ](https://developer.okta.com/docs/guides/sign-into-mobile-app/create-okta-application/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### Ionicã‚¢ãƒ—ãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹

`ionic/src/environments/environment.ts`ã‚’é–‹ãã€Nativeã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¿½åŠ ã—ã¾ã™ã€‚`server_host`ã®å€¤ã¯JHipsterã‚¢ãƒ—ãƒªï¼ˆ`/api/auth-info`ï¼‰ã‹ã‚‰æ¤œç´¢ã•ã‚Œã¾ã™ãŒã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä»£æ›¿ï¼‰å€¤ã¨ã—ã¦å®šç¾©ã§ãã¾ã™ã€‚ä»¥ä¸‹ã¯ä¾‹ã§ã™ã€‚

```ts
oidcConfig: {
  client_id: '<native-client-id>',
  server_host: 'https://<your-okta-domain>/oauth2/default',
  ...
}
```

ã¾ãŸã€`http://localhost:8100`ç”¨ã«ãƒˆãƒ©ã‚¹ãƒ†ãƒƒãƒ‰ãƒ»ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Okta Admin Consoleã§ã€**Security** > **API** > **Trusted Origins** > **Add Origin**ã«ç§»å‹•ã—ã¾ã™ã€‚æ¬¡ã®å€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

- Name: `http://localhost:8100`
- Origin URL: `http://localhost:8100`
- Type: CORS and Redirectã®**ä¸¡æ–¹ã‚’**ãƒã‚§ãƒƒã‚¯

**Save**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

Ionicã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ã€Oktaã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™!

#### Reactãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’`app/config/app-config.js`ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

Ionicã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ã€Oktaã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™!

#### OpenID Connectãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

JHipster 5ã¨OIDC with Oktaã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[JHipsterã§OpenID Connectã‚µãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹](https://developer.okta.com/blog/2017/10/20/oidc-with-jhipster)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

JHipster 6ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€[Java 12ã¨JHipster 6ã«ã‚ˆã‚‹Javaã®æ”¹å–„ã€é«˜é€ŸåŒ–ã€è»½é‡åŒ–](https://developer.okta.com/blog/2019/04/04/java-11-java-12-jhipster-oidc)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚JHipster 6ã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€[Spring Cloud Configã¨JHipsterã‚’ä½¿ã£ãŸJavaãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹](https://developer.okta.com/blog/2019/05/23/java-microservices-spring-cloud-config)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

JHipster 7ã«ã¤ã„ã¦ã¯ã€[Spring Bootã¨JHipsterã‚’ä½¿ã£ãŸãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–Javaãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹](https://developer.okta.com/blog/2021/01/20/reactive-java-microservices)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Oktaé–‹ç™ºè€…ãƒ–ãƒ­ã‚°ã«ã¯ã€Micronautã¨Quarkusã¸ã® â¤ï¸ ã‚‚æ²è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [JHipsterã§ã‚»ã‚­ãƒ¥ã‚¢ãªMicronautã¨Angularã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰ã™ã‚‹](https://developer.okta.com/blog/2020/08/17/micronaut-jhipster-heroku)
- [Quarkusã¨JHipsterã§é«˜é€ŸJavaç°¡å˜ã«](https://developer.okta.com/blog/2021/03/08/jhipster-quarkus-oidc)

<<<<<<< HEAD
### Auth0

Keycloakã®ä»£ã‚ã‚Šã«[Auth0](https://auth0.com/)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€æ¬¡ã®è¨­å®šæ‰‹é †ã«å¾“ã„ã¾ã™ã€‚

#### Auth0 Admin Dashboardã‚’ä½¿ç”¨ã—ãŸOIDCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

- <https://auth0.com/signup>ã§ç„¡æ–™ã®é–‹ç™ºè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŒæˆåŠŸã™ã‚‹ã¨ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯`dev-xxx.us.auth0.com`ã®ã‚ˆã†ãªç‹¬è‡ªã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚
- `Regular Web Applications`ã‚¿ã‚¤ãƒ—ã®æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚`Settings` ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ã€æ¬¡ã®ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’æ§‹æˆã—ã¾ã™ã€‚
    - Allowed Callback URLs: `http://localhost:8080/login/oauth2/code/oidc`
    - Allowed Logout URLs: `http://localhost:8080/`
    - æ³¨æ„ï¼šConsulã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒãƒ¼ãƒˆ8500ã®URLã‚‚è¿½åŠ ã—ã¾ã™ã€‚
    - æ³¨æ„ï¼šJHipsterãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒãƒ¼ãƒˆ8761ã®URLã‚‚è¿½åŠ ã—ã¾ã™ã€‚
- **User Management** > **Roles**ã«ç§»å‹•ã—ã€`ROLE_ADMIN`ãŠã‚ˆã³`ROLE_USER`ã¨ã„ã†åå‰ã®æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
- **User Management** > **Users**ã«ç§»å‹•ã—ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ **Role**ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ãä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å½¹å‰²ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
- **Actions** > **Flows**ã«ç§»å‹•ã—ã€**Login**ã‚’é¸æŠã—ã¾ã™ã€‚`Add Roles`ã¨ã„ã†åå‰ã®æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒˆãƒªã‚¬ãƒ¼ã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`onExecutePostLogin`ãƒãƒ³ãƒ‰ãƒ©ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

  ```js
  exports.onExecutePostLogin = async (event, api) => {
    const namespace = 'https://www.jhipster.tech';
    if (event.authorization) {
      api.idToken.setCustomClaim('preferred_username', event.user.email);
      api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
      api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    }
  }
  ```
- **Deploy**ã‚’é¸æŠã—ã€`Add Roles`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¾ã™ã€‚

_ã“ã‚Œã‚‰ã®æ‰‹é †ã‚’ã™ã¹ã¦è‡ªå‹•åŒ–ã—ãŸã„å ´åˆã¯ã€Auth0 CLIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®[issue #351](https://github.com/auth0/auth0-cli/issues/351)ã«ğŸ‘ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚_

#### Auth0ã‚’OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«JHipsterã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆ

`JHipster`ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€Auth0è¨­å®šã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«`src/main/resources/config/application.yml`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```yaml
spring:
  ...
  security:
    oauth2:
      client:
        provider:
          oidc:
            # å¿…ãšæœ€å¾Œã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼
            issuer-uri: https://{your-auth0-domain}/
        registration:
          oidc:
            client-id: {clientId}
            client-secret: {clientSecret}
            scope: openid,profile,email
jhipster:
  security:
    oauth2:
      audience: https://{your-auth0-domain}/api/v2/
```

`issuer-uri`ã®å€¤ã«ç–‘å•ãŒã‚ã‚‹å ´åˆã¯ã€**Applications** > **{Your Application}** > **Settings** > **Advanced Settings** > **Endpoints** > **OpenID Configuration**ã‹ã‚‰å€¤ã‚’å–å¾—ã§ãã¾ã™ã€‚`.well-known/openid-configuration`ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯Spring Securityã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚Œã‚‹ã®ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

**Applications** > **API** > **API Audience**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`Auth0 Management API`ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹å€¤ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ç‹¬è‡ªã®ã‚«ã‚¹ã‚¿ãƒ APIã‚’å®šç¾©ã—ã¦ã€è­˜åˆ¥å­ã‚’APIã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

- `Cypress`ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€`CYPRESS_E2E_USERNAME`ãŠã‚ˆã³`CYPRESS_E2E_PASSWORD`ç’°å¢ƒå¤‰æ•°ã‚’ä¸Šæ›¸ãã—ã¦ã€`Auth0`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Cypressã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.cypress.io/guides/guides/environment-variables#Setting)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```shell
export CYPRESS_E2E_USERNAME=<your-username>
export CYPRESS_E2E_PASSWORD=<your-password>
```

_æ³¨æ„_ï¼šAuth0ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æœ€åˆã®ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«èªå¯ã®åŒæ„ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚åŒæ„ãƒ•ãƒ­ãƒ¼ã¯ç¾åœ¨ã€Cypressãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã§ã¯å‡¦ç†ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã®å•é¡Œã‚’è»½æ¸›ã™ã‚‹ã«ã¯ã€ã™ã§ã«åŒæ„ã‚’ä»˜ä¸ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€å¯¾è©±å‹ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä»‹ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã§ãã¾ã™ã€‚

Cypressã§èªè¨¼ã®å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®å›é¿ç­–ã«ã¤ã„ã¦ã¯ã€[ã“ã®ã‚¬ã‚¤ãƒ‰](https://docs.cypress.io/guides/testing-strategies/auth0-authentication#Auth0-Rate-Limiting-Logins)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨

ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸Šæ›¸ã‚‚ã§ãã¾ã™ã€‚æ¬¡ã«ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

```bash
export SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI="https://{your-auth0-domain}/"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID="{client-id}"
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET="{client-secret}"
export JHIPSTER_SECURITY_OAUTH2_AUDIENCE="https://{your-auth0-domain}/api/v2/"
```

ã“ã‚Œã‚’`~/.auth0.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«å…¥ã‚Œã¦`source ~/.auth0.env`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Keycloakè¨­å®šã‚’Auth0ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã€Mavenã¾ãŸã¯Gradleã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã§ãã¾ã™ã€‚ç™»éŒ²ã—ãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã¯ãšã§ã™ã€‚

_æ³¨æ„_ï¼šWindowsã®å ´åˆã¯ã€`source`ã‚³ãƒãƒ³ãƒ‰ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€[WSL](https://docs.microsoft.com/en-us/windows/wsl/install-win10)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

<a name="create-native-app-auth0"></a>
#### Auth0ã§ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹

JHipsterã®[Ionic](https://github.com/jhipster/generator-jhipster-ionic)ã¾ãŸã¯[React Native](https://github.com/jhipster/generator-jhipster-react-native)ã®Blueprintã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ã„ã‚‹å ´åˆã€OIDCã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãªã‚‰ã€Auth0ã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

1. **Native**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ¬¡ã®Allowed Callback URLsã‚’è¿½åŠ ã—ã¾ã™ã€‚

    - Ionic: `http://localhost:8100/callback,dev.localhost.ionic:/callback`
    - React Native: `http://localhost:19006/,https://auth.expo.io/@<username>/<appname>`

2. Allowed Logout URLsã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

    - Ionic: `http://localhost:8100/logout,dev.localhost.ionic:/logout`
    - React: `http://localhost:19006/,https://auth.expo.io/@<username>/<appname>`

3. Allowed Origins (CORS)ã‚’è¨­å®šã—ã¾ã™ã€‚

    - Ionic: `http://localhost:8100,capacitor://localhost,http://localhost`
    - React Native: `http://localhost:19006`

#### Ionicã‚¢ãƒ—ãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹

ç”Ÿæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã€`ionic/src/environments/environment.ts`ã‚’æ›´æ–°ã—ã¾ã™ã€‚`server_host`ã®å€¤ã¯ã€JHipsterã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`/api/auth-info`ï¼‰ã‹ã‚‰æ¤œç´¢ã•ã‚Œã¾ã™ãŒã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã¨ã—ã¦ã®å®šç¾©ã‚‚ã§ãã¾ã™ã€‚ã¾ãŸã€audienceã‚‚æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã¯ä¾‹ã§ã™ã€‚

```ts
const oidcConfig: IAuthConfig = {
  client_id: '<native-client-id>',
  server_host: 'https://<your-auth0-domain>/',
  ...
};

export const environment = {
  ...
  audience: 'https://<your-auth0-domain>/api/v2/',
  ...
};
```

Ionicã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã€Auth0ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ï¼

#### Reactãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’`app/config/app-config.js`ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

`app/modules/login/login.utils.ts`ã®`audience`ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```ts
audience: 'https://<your-auth0-domain>/api/v2/',
```

React Nativeã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã€Auth0ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ï¼

<!--
#### OpenID Connect Tutorials

// coming soon!
-->

=======
>>>>>>> upstream/main
<h2 id="https">HTTPS</h2>

HTTPSã®ä½¿ç”¨ã‚’å¼·åˆ¶ã™ã‚‹ã«ã¯ã€æ¬¡ã®è¨­å®šã‚’`SecurityConfiguration.java`ã«è¿½åŠ ã—ã¾ã™ã€‚

```java
// Spring MVC
http.requiresChannel(channel -> channel
    .requestMatchers(r -> r.getHeader("X-Forwarded-Proto") != null).requiresSecure());
    
// WebFlux
http.redirectToHttps(redirect -> redirect
    .httpsRedirectWhen(e -> e.getRequest().getHeaders().containsKey("X-Forwarded-Proto")));
```

è©³ç´°ã«ã¤ã„ã¦ã¯ã€Spring Securityã®[Servlet](https://docs.spring.io/spring-security/site/docs/5.5.x/reference/html5/#servlet-http-redirect)ã¨[WebFlux](https://docs.spring.io/spring-security/site/docs/5.5.x/reference/html5/#webflux-http-redirect)ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã¯Herokuã¨Google Cloudã§ãƒ†ã‚¹ãƒˆã•ã‚Œã€å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã™ã€‚Herokuã§ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ’ãƒ³ãƒˆã«ã¤ã„ã¦ã¯ã€[Herokuã§ã®é‹ç”¨ã®ãŸã‚ã®Spring Bootã‚¢ãƒ—ãƒªã®æº–å‚™](https://devcenter.heroku.com/articles/preparing-a-spring-boot-app-for-production-on-heroku)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

<h2 id="implementation-details">å®Ÿè£…è©³ç´°ã®æ¼æ´©</h2>

ã™ã¹ã¦ã®å¤±æ•—/ä¾‹å¤–ã¯ã€[å•é¡Œãƒ‡ãƒ¼ã‚¿æ§‹é€ ](https://github.com/zalando/problem)ã«ãƒãƒƒãƒ—ã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã•ã‚Œã¾ã™ã€‚

```json
{  
  "type": "https://www.jhipster.tech/problem/problem-with-message",
  "title": "Service Unavailable",
  "status": 503,
  "detail": "Database not reachable"
}
```

JHipsterã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å«ã‚“ã§ã„ã¾ã›ã‚“ãŒã€`detail`ã«ã¯ä¾‹å¤–ã®`message`ãŒå«ã¾ã‚Œã€APIã‚’ä»‹ã—ã¦å…¬é–‹ã•ã‚ŒãŸããªã„[æŠ€è¡“çš„è©³ç´°](https://github.com/jhipster/generator-jhipster/issues/12051)
ãŒè¡¨ã‚Œã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```json
{  
  "type": "https://www.jhipster.tech/problem/problem-with-message",
  "title": "Bad Request",
  "status": 400,
  "detail": "JSON parse error: Cannot deserialize instance of 
       `java.util.LinkedHashMap<java.lang.Object,java.lang.Object>` out of VALUE_NUMBER_INT token; nested exception is com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot deserialize instance of `java.util.LinkedHashMap<java.lang.Object,java.lang.Object>` 
       out of VALUE_NUMBER_INT token\n at [Source: (PushbackInputStream); line: 1, column: 1]"
}
```

ã“ã‚Œã‚’é˜²ããŸã‚ã«ã€JHipsterã¯ã€å®Ÿè£…ã®è©³ç´°ã®æ¼ã‚Œã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã®å°‚ç”¨ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã¾ã™ã€‚

* æ—¢çŸ¥ã®ä¾‹å¤–ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€èˆ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆã¾ã™ï¼ˆä¾‹ï¼š`Unable to convert http message`ï¼‰ã€‚
* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ½œåœ¨çš„ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼ˆä¾‹ï¼š`java.`ã¾ãŸã¯`.org`ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€èˆ¬çš„ãªã‚‚ã®ï¼ˆä¾‹ï¼š`Unexpected runtime exception`ï¼‰ã§ç½®ãæ›ãˆã¾ã™ã€‚

ãƒ­ã‚°ã«ã¯ä¾ç„¶ã¨ã—ã¦è©³ç´°ãªä¾‹å¤–ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€å¤–éƒ¨ã‹ã‚‰ã®æ”»æ’ƒè€…ãŒAPIã‚’æ‚ªç”¨ã—ã¦è²´é‡ãªæŠ€è¡“çš„è©³ç´°ã‚’å¾—ã‚‹ã“ã¨ãŒã§ããªã„é–“ã«ã€
å®Ÿéš›ã®å•é¡Œã‚’ç‰¹å®šã§ãã¾ã™ï¼ˆè¨³æ³¨ï¼šmiusingâ†’misusingï¼‰ã€‚

ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æŠ€è¡“çš„ãªè©³ç´°ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚æ¤œå‡ºã•ã‚Œãªã‹ã£ãŸå ´åˆãªã©ï¼‰ã¯ã€
å¿…è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’`ExceptionTranslator.java`ã®`prepare`ãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ ã™ã‚‹ã“ã¨ã§å¤‰æ›´ã§ãã¾ã™ã€‚
